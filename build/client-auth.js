// Generated by CoffeeScript 1.6.1
(function() {
  var ChatConnection, MS, NETCODES, SESSID, cc, chatServer, createMsgRequest, dh, logConnectionInfo;

  MS = window.MessageSerializer;

  NETCODES = window.NETCODES;

  dh = window.Domhandle;

  ChatConnection = (function() {

    function ChatConnection(server, sessid) {
      this.server = server;
      this.sessid = sessid;
      this.ws = void 0;
      this.authenticated = false;
      this.msgID = 10;
      this.uID = "";
      this.callbacks = {
        "message": void 0
      };
    }

    ChatConnection.prototype.connect = function() {
      var _this = this;
      this.ws = new WebSocket(this.server);
      this.ws.onopen = function() {
        return _this.authenticate();
      };
      return void 0;
    };

    ChatConnection.prototype.handleMessage = function(msg) {
      var parsedMsg;
      console.log(msg);
      console.log(msg.data);
      parsedMsg = MS.deserialize(msg.data);
      return this.emit("message", parsedMsg);
    };

    ChatConnection.prototype.emit = function(event, arg) {
      var callback, evt, _ref, _results;
      _ref = this.callbacks;
      _results = [];
      for (evt in _ref) {
        callback = _ref[evt];
        if (evt === event) {
          _results.push(callback(arg));
        }
      }
      return _results;
    };

    ChatConnection.prototype.on = function(event, callback) {
      return this.callbacks[event] = callback;
    };

    ChatConnection.prototype.sendMessage = function(msgObj) {
      msgObj.id = this.msgID;
      this.msgID++;
      return this.ws.send(MS.serialize(createMsgRequest(msgObj)));
    };

    ChatConnection.prototype.authenticate = function() {
      var _this = this;
      this.ws.onmessage = function(msg) {
        var authObject, _ref, _ref1;
        console.log("Message: " + msg.data);
        authObject = MS.deserialize(msg.data);
        if ((authObject != null ? authObject.type : void 0) === !NETCODES.AUTH_RES || !(authObject != null ? (_ref = authObject.response) != null ? _ref.value : void 0 : void 0) || !(authObject != null ? (_ref1 = authObject.response) != null ? _ref1.uID : void 0 : void 0)) {
          logConnectionInfo("AUTH_RES INVALID");
          _this.authenticated = false;
        }
        if (authObject.response.value === true) {
          _this.uID = authObject.response.uID;
          logConnectionInfo("Client verified.");
          _this.authenticated = true;
          return _this.ws.onmessage = _this.handleMessage;
        }
      };
      this.ws.send(MS.serialize({
        type: NETCODES.AUTH_REQ,
        SESSID: this.sessid
      }));
      return console.log(MS.serialize({
        type: NETCODES.AUTH_REQ,
        SESSID: this.sessid
      }));
    };

    return ChatConnection;

  })();

  logConnectionInfo = function(info) {
    return console.log(info);
  };

  createMsgRequest = function(msgObj) {
    var request;
    request = {
      type: NETCODES.MSG_SEND_REQ,
      message: msgObj
    };
    return request;
  };

  chatServer = "ws://127.0.0.1:1337";

  SESSID = window.getCookie("PORTALNSESSID");

  cc = new ChatConnection(chatServer, SESSID);

  cc.connect();

  cc.on("message", function(msgObject) {
    return console.log(msgObject);
  });

  window.cc = cc;

}).call(this);
